<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Users - BallotHub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .user-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .status-badge {
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
    }
    .btn-action {
      margin: 0.2rem;
    }
    .search-box {
      max-width: 400px;
    }
  </style>
  <script>
    const token = localStorage.getItem('admin_token');
    
    if (!token) {
      window.location.href = '/admin';
    }
    
    let allUsers = [];
    
    async function loadUsers() {
      if (!token) return;
      try {
        const res = await fetch('/api/admin/users', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        allUsers = data.users || [];
        displayUsers(allUsers);
        updateStats();
      } catch (e) {
        console.error('Failed to load users:', e);
        document.getElementById('usersContainer').innerHTML = `
          <div class="alert alert-danger">Error loading users: ${e.message}</div>
        `;
      }
    }
    
    function displayUsers(users) {
      const container = document.getElementById('usersContainer');
      
      if (users.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info text-center">
            <h5>No Users Found</h5>
            <p>No users have registered yet.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = users.map((user, index) => {
        const statusClass = user.status === 'approved' ? 'bg-success' : 'bg-warning text-dark';
        const votedBadge = user.voted ? '<span class="badge bg-info ms-2">‚úì Voted</span>' : '';
        
        return `
          <div class="card mb-3 user-card fade-in" style="animation-delay: ${index * 0.05}s;">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <h5 class="card-title mb-2" style="font-weight: 600; color: #1e293b;">
                    ${user.name}
                    ${votedBadge}
                  </h5>
                  <p class="mb-1 text-muted">
                    <small><strong>üìß Email:</strong> ${user.email}</small>
                  </p>
                  <span class="badge ${statusClass} status-badge mt-2">${user.status.toUpperCase()}</span>
                </div>
                <div class="col-md-4 text-end">
                  <div class="btn-group-vertical btn-group-sm" role="group">
                    ${user.status === 'pending' ? `
                      <button 
                        class="btn btn-success btn-action mb-1 w-100" 
                        onclick="approveUser('${user.user_id}', '${user.name}')"
                        title="Approve User">
                        ‚úì Approve
                      </button>
                      <button 
                        class="btn btn-warning btn-action mb-1 w-100" 
                        onclick="rejectUser('${user.user_id}', '${user.name}')"
                        title="Reject User">
                        ‚úó Reject
                      </button>
                    ` : ''}
                    <button 
                      class="btn btn-danger btn-action ${user.status === 'pending' ? 'w-100' : ''}" 
                      onclick="deleteUser('${user.user_id}', '${user.name}')"
                      title="Delete User">
                      üóë Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function updateStats() {
      const total = allUsers.length;
      const approved = allUsers.filter(u => u.status === 'approved').length;
      const pending = allUsers.filter(u => u.status === 'pending').length;
      const voted = allUsers.filter(u => u.voted).length;
      
      document.getElementById('totalCount').textContent = total;
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('votedCount').textContent = voted;
    }
    
    function filterUsers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      
      let filtered = allUsers;
      
      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(user => 
          user.name.toLowerCase().includes(searchTerm) ||
          user.email.toLowerCase().includes(searchTerm) ||
          (user.phone_masked && user.phone_masked.includes(searchTerm))
        );
      }
      
      // Filter by status
      if (statusFilter !== 'all') {
        filtered = filtered.filter(user => user.status === statusFilter);
      }
      
      displayUsers(filtered);
    }
    
    async function approveUser(userId, userName) {
      if (!token) return;
      if (!confirm(`Approve user "${userName}"?`)) return;
      
      try {
        const res = await fetch(`/api/admin/approve_user/${userId}`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token 
          }
        });
        const data = await res.json();
        if (res.ok) {
          alert('User approved successfully!');
          loadUsers();
        } else {
          alert('Error: ' + (data.error || 'Failed to approve user'));
        }
      } catch (e) {
        alert('Error approving user: ' + e.message);
      }
    }
    
    async function rejectUser(userId, userName) {
      if (!token) return;
      if (!confirm(`Reject registration for "${userName}"? This will permanently delete their account.`)) return;
      
      try {
        const res = await fetch(`/api/admin/reject_user/${userId}`, {
          method: 'DELETE',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token 
          }
        });
        const data = await res.json();
        if (res.ok) {
          alert('User registration has been rejected and their account has been deleted.');
          loadUsers();
        } else {
          alert('Error: ' + (data.error || 'Failed to reject user'));
        }
      } catch (e) {
        alert('Error rejecting user: ' + e.message);
      }
    }
    
    async function deleteUser(userId, userName) {
      if (!token) return;
      
      const confirmMsg = `Are you sure you want to delete user "${userName}"?\n\n` +
        `‚ö†Ô∏è WARNING: This will permanently delete:\n` +
        `- The user account\n` +
        `- All votes cast by this user\n\n` +
        `This action cannot be undone!`;
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      // Double confirmation
      if (!confirm('This is your last chance. Delete this user?')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/delete_user/${userId}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        
        const data = await res.json();
        if (res.ok) {
          alert(data.message || 'User deleted successfully!');
          loadUsers();
        } else {
          alert('Error: ' + (data.error || 'Failed to delete user'));
        }
      } catch (e) {
        alert('Error deleting user: ' + e.message);
      }
    }
    
    window.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</head>
<body>
  <nav class="navbar navbar-light mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/admin/dashboard" style="font-size: 1.5rem;">üéØ BallotHub Admin</a>
      <div>
        <a href="/admin/dashboard" class="btn btn-outline-secondary btn-sm">‚Üê Dashboard</a>
      </div>
    </div>
  </nav>
  
  <div class="container py-4 dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="gradient-text" style="font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
        Manage Users
      </h2>
      <div>
        <button onclick="loadUsers()" class="btn btn-outline-light">
          üîÑ Refresh
        </button>
      </div>
    </div>
    
    <!-- Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="mb-0" id="totalCount">0</h3>
            <small class="text-muted">Total Users</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="mb-0 text-success" id="approvedCount">0</h3>
            <small class="text-muted">Approved</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="mb-0 text-warning" id="pendingCount">0</h3>
            <small class="text-muted">Pending</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="mb-0 text-info" id="votedCount">0</h3>
            <small class="text-muted">Voted</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Search Users</label>
            <input 
              type="text" 
              id="searchInput" 
              class="form-control search-box" 
              placeholder="Search by name, email, or phone..."
              oninput="filterUsers()">
          </div>
          <div class="col-md-6">
            <label class="form-label">Filter by Status</label>
            <select id="statusFilter" class="form-select" onchange="filterUsers()">
              <option value="all">All Users</option>
              <option value="approved">Approved</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <div id="usersContainer">
      <div class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading users...</p>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/interactive.js"></script>
</body>
</html>

